{% extends "base.html" %}

{% block title %}AI Chat - WellnessWeavers{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <!-- Sidebar -->
        <div class="col-md-3 col-lg-2 sidebar">
            <div class="position-sticky pt-3">
                <ul class="nav flex-column">
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('dashboard.index') }}">
                            <i class="fas fa-home"></i> Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('dashboard.analytics') }}">
                            <i class="fas fa-chart-line"></i> Analytics
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="{{ url_for('dashboard.chat') }}">
                            <i class="fas fa-comments"></i> AI Chat
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('dashboard.voice_journal') }}">
                            <i class="fas fa-microphone"></i> Voice Journal
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('dashboard.profile') }}">
                            <i class="fas fa-user"></i> Profile
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('dashboard.settings') }}">
                            <i class="fas fa-cog"></i> Settings
                        </a>
                    </li>
                </ul>
            </div>
        </div>

        <!-- Main content -->
        <div class="col-md-9 col-lg-10 main-content">
            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                <h1 class="h2">AI Wellness Companion</h1>
                <div class="btn-toolbar mb-2 mb-md-0">
                    <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#aiSettingsModal">
                        <i class="fas fa-cog"></i> AI Settings
                    </button>
                </div>
            </div>

            <!-- Chat Interface -->
            <div class="row">
                <div class="col-12">
                    <div class="card chat-container">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <div class="d-flex align-items-center">
                                <div class="ai-avatar me-3">
                                    <i class="fas fa-robot"></i>
                                </div>
                                <div>
                                    <h6 class="mb-0">Wellness AI</h6>
                                    <small class="text-muted">Your mental health companion</small>
                                </div>
                            </div>
                            <div class="chat-status">
                                <span class="badge bg-success">Online</span>
                            </div>
                        </div>
                        <div class="card-body chat-messages" id="chatMessages">
                            <!-- Welcome message -->
                            <div class="message ai-message">
                                <div class="message-content">
                                    <div class="message-text">
                                        Hello! I'm your Wellness AI companion. I'm here to listen, support, and help you on your mental health journey. How are you feeling today?
                                    </div>
                                    <div class="message-time">{{ moment().format('HH:mm') }}</div>
                                </div>
                            </div>
                        </div>
                        <div class="card-footer">
                            <form id="chatForm" class="d-flex">
                                <div class="input-group">
                                    <input type="text" class="form-control" id="messageInput" placeholder="Type your message..." autocomplete="off">
                                    <button class="btn btn-outline-secondary" type="button" id="voiceButton">
                                        <i class="fas fa-microphone"></i>
                                    </button>
                                    <button class="btn btn-primary" type="submit">
                                        <i class="fas fa-paper-plane"></i>
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="row mt-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">Quick Actions</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-3 mb-2">
                                    <button class="btn btn-outline-primary w-100 quick-action" data-message="I'm feeling anxious today">
                                        <i class="fas fa-heart"></i> Feeling Anxious
                                    </button>
                                </div>
                                <div class="col-md-3 mb-2">
                                    <button class="btn btn-outline-success w-100 quick-action" data-message="I'm having a great day!">
                                        <i class="fas fa-smile"></i> Great Day
                                    </button>
                                </div>
                                <div class="col-md-3 mb-2">
                                    <button class="btn btn-outline-info w-100 quick-action" data-message="I need help with stress management">
                                        <i class="fas fa-leaf"></i> Stress Help
                                    </button>
                                </div>
                                <div class="col-md-3 mb-2">
                                    <button class="btn btn-outline-warning w-100 quick-action" data-message="I want to talk about my goals">
                                        <i class="fas fa-target"></i> Goals
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Conversations -->
            {% if recent_conversations %}
            <div class="row mt-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">Recent Conversations</h5>
                        </div>
                        <div class="card-body">
                            <div class="conversation-list">
                                {% for conversation in recent_conversations %}
                                <div class="conversation-item d-flex justify-content-between align-items-center mb-2">
                                    <div class="conversation-preview">
                                        <div class="conversation-title">{{ conversation.title or 'Conversation' }}</div>
                                        <div class="conversation-summary">{{ conversation.summary[:100] }}{% if conversation.summary|length > 100 %}...{% endif %}</div>
                                    </div>
                                    <div class="conversation-meta">
                                        <small class="text-muted">{{ conversation.created_at.strftime('%b %d, %Y') }}</small>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- AI Settings Modal -->
<div class="modal fade" id="aiSettingsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">AI Companion Settings</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="aiSettingsForm">
                    <div class="mb-3">
                        <label class="form-label">AI Personality</label>
                        <select class="form-select" name="personality">
                            <option value="supportive_friend">Supportive Friend</option>
                            <option value="professional_therapist">Professional Therapist</option>
                            <option value="motivational_coach">Motivational Coach</option>
                            <option value="empathetic_listener">Empathetic Listener</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Conversation Style</label>
                        <select class="form-select" name="conversation_style">
                            <option value="casual">Casual</option>
                            <option value="formal">Formal</option>
                            <option value="encouraging">Encouraging</option>
                            <option value="analytical">Analytical</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">AI Name</label>
                        <input type="text" class="form-control" name="ai_name" value="Wellness AI">
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="crisis_detection" checked>
                            <label class="form-check-label">
                                Enable crisis detection and intervention
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveAISettings">Save Settings</button>
            </div>
        </div>
    </div>
</div>

<style>
.sidebar {
    background-color: #f8f9fa;
    min-height: 100vh;
    border-right: 1px solid #dee2e6;
}

.sidebar .nav-link {
    color: #495057;
    padding: 0.75rem 1rem;
    border-radius: 0.375rem;
    margin-bottom: 0.25rem;
}

.sidebar .nav-link:hover {
    background-color: #e9ecef;
}

.sidebar .nav-link.active {
    background-color: #0d6efd;
    color: white;
}

.chat-container {
    height: 600px;
    display: flex;
    flex-direction: column;
}

.chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 1rem;
    background-color: #f8f9fa;
}

.message {
    margin-bottom: 1rem;
    display: flex;
}

.message.user-message {
    justify-content: flex-end;
}

.message.ai-message {
    justify-content: flex-start;
}

.message-content {
    max-width: 70%;
    padding: 0.75rem 1rem;
    border-radius: 1rem;
    position: relative;
}

.user-message .message-content {
    background-color: #007bff;
    color: white;
    border-bottom-right-radius: 0.25rem;
}

.ai-message .message-content {
    background-color: white;
    color: #333;
    border: 1px solid #dee2e6;
    border-bottom-left-radius: 0.25rem;
}

.message-time {
    font-size: 0.75rem;
    opacity: 0.7;
    margin-top: 0.25rem;
}

.ai-avatar {
    width: 40px;
    height: 40px;
    background-color: #007bff;
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
}

.conversation-item {
    padding: 0.75rem;
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    background-color: #f8f9fa;
    cursor: pointer;
    transition: background-color 0.2s;
}

.conversation-item:hover {
    background-color: #e9ecef;
}

.conversation-title {
    font-weight: 500;
    color: #495057;
}

.conversation-summary {
    color: #6c757d;
    font-size: 0.875rem;
}

.quick-action {
    transition: transform 0.2s;
}

.quick-action:hover {
    transform: translateY(-2px);
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const chatForm = document.getElementById('chatForm');
    const messageInput = document.getElementById('messageInput');
    const chatMessages = document.getElementById('chatMessages');
    const voiceButton = document.getElementById('voiceButton');
    
    let isRecording = false;
    let recognition = null;
    
    // Initialize speech recognition if available
    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new SpeechRecognition();
        recognition.continuous = false;
        recognition.interimResults = false;
        recognition.lang = 'en-US';
        
        recognition.onresult = function(event) {
            const transcript = event.results[0][0].transcript;
            messageInput.value = transcript;
        };
        
        recognition.onerror = function(event) {
            console.error('Speech recognition error:', event.error);
        };
    }
    
    // Handle form submission
    chatForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const message = messageInput.value.trim();
        if (message) {
            sendMessage(message);
            messageInput.value = '';
        }
    });
    
    // Handle quick actions
    document.querySelectorAll('.quick-action').forEach(button => {
        button.addEventListener('click', function() {
            const message = this.dataset.message;
            sendMessage(message);
        });
    });
    
    // Handle voice button
    voiceButton.addEventListener('click', function() {
        if (recognition) {
            if (isRecording) {
                recognition.stop();
                isRecording = false;
                this.innerHTML = '<i class="fas fa-microphone"></i>';
                this.classList.remove('btn-danger');
                this.classList.add('btn-outline-secondary');
            } else {
                recognition.start();
                isRecording = true;
                this.innerHTML = '<i class="fas fa-stop"></i>';
                this.classList.remove('btn-outline-secondary');
                this.classList.add('btn-danger');
            }
        } else {
            alert('Speech recognition not supported in this browser');
        }
    });
    
    function sendMessage(message) {
        // Add user message to chat
        addMessage(message, 'user');
        
        // Show typing indicator
        showTypingIndicator();
        
        // Send to AI (simulate for now)
        setTimeout(() => {
            hideTypingIndicator();
            const aiResponse = generateAIResponse(message);
            addMessage(aiResponse, 'ai');
        }, 1000 + Math.random() * 2000); // Simulate AI thinking time
    }
    
    function addMessage(text, sender) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${sender}-message`;
        
        const now = new Date();
        const timeString = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        
        messageDiv.innerHTML = `
            <div class="message-content">
                <div class="message-text">${text}</div>
                <div class="message-time">${timeString}</div>
            </div>
        `;
        
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    
    function showTypingIndicator() {
        const typingDiv = document.createElement('div');
        typingDiv.className = 'message ai-message';
        typingDiv.id = 'typingIndicator';
        typingDiv.innerHTML = `
            <div class="message-content">
                <div class="message-text">
                    <span class="typing-dots">
                        <span>.</span><span>.</span><span>.</span>
                    </span>
                </div>
            </div>
        `;
        chatMessages.appendChild(typingDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    
    function hideTypingIndicator() {
        const typingDiv = document.getElementById('typingIndicator');
        if (typingDiv) {
            typingDiv.remove();
        }
    }
    
    function generateAIResponse(userMessage) {
        // Simple AI response simulation
        const responses = [
            "I understand how you're feeling. Can you tell me more about what's on your mind?",
            "That sounds challenging. Remember, it's okay to feel this way. What would help you feel better?",
            "I'm here to listen and support you. What steps do you think might help in this situation?",
            "Your feelings are valid. Let's work through this together. What's one small thing you could do for yourself today?",
            "I appreciate you sharing that with me. How can I best support you right now?",
            "It takes courage to talk about these things. What would you like to focus on today?",
            "I'm glad you're reaching out. Remember, you're not alone in this. What's been helpful for you in the past?"
        ];
        
        return responses[Math.floor(Math.random() * responses.length)];
    }
    
    // Handle AI settings
    document.getElementById('saveAISettings').addEventListener('click', function() {
        const form = document.getElementById('aiSettingsForm');
        const formData = new FormData(form);
        
        // Save settings (simulate)
        console.log('AI Settings:', Object.fromEntries(formData));
        alert('AI settings saved!');
        
        // Close modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('aiSettingsModal'));
        modal.hide();
    });
});
</script>
{% endblock %}
